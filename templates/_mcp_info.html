<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Service Info - {{ serviceName | default('Unknown') }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/_mcp_info.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/_json.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/basic_tabs.css') }}">
</head>
<body style="margin: 0; padding: 0; width: 100%; height: 100vh; overflow: hidden; box-sizing: border-box;">
<div class="container_main" style="width: 100%; height: 100%; overflow: hidden; box-sizing: border-box;">
    <!-- 第一行：标题 -->
    <header class="header-section">
        <h1>{{ serviceName | default('无内容') }}</h1>
    </header>

    <!-- 第二行：左右布局 -->
    <div class="main-content">

        <!-- 左侧：文本区 (可滚动) -->
         <div class="left-panel" style="width: 35%;">
            <p>Tool info</p>
                <pre><code style = "white-space: pre-wrap; word-break: break-word; font-size: clamp(14px, 1rem, 24px)">{{ serviceInfo }}</code></pre>
            </div>
<!--             
         <div class="tabs" style="width: 35%;">
            <button class="tab-btn active" data-tab="tab1">Tools (json)</button>
        </div>

        <div class="tab-content active" id="tab1">
            
        </div> -->

        <!-- 中间：参数填报区 -->
        <form class="param-panel" id="tool-form">

            <!-- 工具名称输入区域 -->
            <div class="tool-name-section">
                <div class="form-group">
                    <label for="tool-name">Tool Name</label>
                    <input type="text" id="tool-name" name="tool_name" placeholder="Input tool name." required>
                </div>
            </div>

            <!-- 参数区域 -->
            <div class="params-section">
                <div class="section-header">
                    <h4>Parameters</h4>
                    <button type="button" class="btn-add-param" onclick="addParameter()">
                        + Add Parameter
                    </button>
                </div>

                <!-- 参数输入区域 (可滚动) -->
                <div class="form-scroll-area">
                    <div id="parameters-container">
                        <!-- 默认参数对 -->
                        <div class="param-pair" data-param-id="1">
                            <div class="param-input-group">
                                <input type="text" class="param-key" placeholder="key" name="param_key_1">
                                <input type="text" class="param-value" placeholder="value" name="param_value_1">
                                <select class="param-type" name="param_type_1" onchange="handleTypeChange(this)">
                                    <option value="text" selected>Text</option>
                                    <option value="number">Number</option>
                                    <option value="boolean">Boolean</option>
                                    <option value="null">Null</option>
                                </select>
                                <button type="button" class="btn-remove-param" onclick="removeParameter(1)">×</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 按钮区域 (固定在底部) -->
            <div class="form-footer">
                <button type="button" class="btn-basic btn-reset" onclick="resetForm()">Reset</button>
                <button type="button" class="btn-basic btn-submit" onclick="submitForm()">Submit</button>
            </div>

        </form>

        <!-- 右侧：结果区 (可滚动) -->
        <div class="right-panel" style="width: 30%;">
            {{ serviceResult | default('Submit to get results.') }}
        </div>

    </div>
</div>

<script>
    // 参数计数器
    let paramCount = 1;

    // 添加参数对
    function addParameter() {
        paramCount++;
        const container = document.getElementById('parameters-container');

        const paramPair = document.createElement('div');
        paramPair.className = 'param-pair';
        paramPair.setAttribute('data-param-id', paramCount);

        paramPair.innerHTML = `
            <div class="param-input-group">
                <input type="text" class="param-key" placeholder="key" name="param_key_${paramCount}">
                <input type="text" class="param-value" placeholder="value" name="param_value_${paramCount}">
                <select class="param-type" name="param_type_${paramCount}" onchange="handleTypeChange(this)">
                    <option value="text" selected>Text</option>
                    <option value="number">Number</option>
                    <option value="boolean">Boolean</option>
                    <option value="null">Null</option>
                </select>
                <button type="button" class="btn-remove-param" onclick="removeParameter(${paramCount})">×</button>
            </div>
        `;

        container.appendChild(paramPair);
    }

    // 移除参数对
    function removeParameter(paramId) {
        const paramPair = document.querySelector(`[data-param-id="${paramId}"]`);
        if (paramPair) {
            paramPair.remove();
        }
    }

    // 处理类型选择变化
    function handleTypeChange(selectElement) {
        const paramInputGroup = selectElement.closest('.param-input-group');
        const valueInput = paramInputGroup.querySelector('.param-value');
        const selectedType = selectElement.value;

        if (selectedType === 'null') {
            // Null类型：禁用输入框并显示"-"
            valueInput.value = '-';
            valueInput.disabled = true;
            valueInput.style.backgroundColor = '#f5f5f5';
            valueInput.style.cursor = 'not-allowed';
        } else {
            // 其他类型：恢复输入框
            if (valueInput.value === '-') {
                valueInput.value = '';
            }
            valueInput.disabled = false;
            valueInput.style.backgroundColor = '';
            valueInput.style.cursor = '';
        }
    }

    // 收集表单数据并转换为JSON
    function collectFormData() {
        const toolName = document.getElementById('tool-name').value.trim();

        const parameters = {};
        const paramPairs = document.querySelectorAll('.param-pair');

        paramPairs.forEach(pair => {
            const key = pair.querySelector('.param-key').value.trim();
            const valueInput = pair.querySelector('.param-value');
            const typeSelect = pair.querySelector('.param-type');

            if (key) {
                const paramType = typeSelect ? typeSelect.value : 'text';

                // 根据类型转换值
                let value;
                if (paramType === 'null') {
                    value = null;
                } else if (paramType === 'boolean') {
                    const rawValue = valueInput.value.trim().toLowerCase();
                    if (rawValue === 'true' || rawValue === '1' || rawValue === 'yes') {
                        value = true;
                    } else if (rawValue === 'false' || rawValue === '0' || rawValue === 'no') {
                        value = false;
                    } else {
                        // 如果输入不明确，默认为 true（非空字符串）或 false
                        value = rawValue.length > 0;
                    }
                } else if (paramType === 'number') {
                    const rawValue = valueInput.value.trim();
                    if (rawValue) {
                        value = Number(rawValue);
                    } else {
                        value = 0;
                    }
                } else {
                    // text 类型，直接使用字符串值
                    value = valueInput.value.trim();
                }

                parameters[key] = value;
            }
        });

        return {
            tool_name: toolName,
            parameters: parameters
        };
    }

    // 提交表单
    function submitForm() {
        const formData = collectFormData();

        // 验证工具名称
        if (!formData.tool_name) {
            alert('请输入工具名称！');
            document.getElementById('tool-name').focus();
            return;
        }

        // 获取服务名称（从页面标题中获取）
        const serviceName = document.querySelector('.header-section h1').textContent;

        // 显示加载状态
        const resultPanel = document.querySelector('.right-panel');
        if (resultPanel) {
            resultPanel.innerHTML = `
                <div style="padding: 20px; text-align: center;">
                    <div style="color: #007bff; font-size: 16px;">正在调用工具...</div>
                    <div style="margin-top: 10px; font-size: 14px; color: #666;">请稍候</div>
                </div>
            `;
        }

        // 发送请求到服务器
        fetch(`/api/services/${encodeURIComponent(serviceName)}/call_tool`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || `HTTP ${response.status}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('服务器响应:', data);

            // 显示结果
            if (resultPanel) {
                if (data.success) {
                    resultPanel.innerHTML = `
                        <h4 style="color: #28a745;">工具调用成功</h4>
                        <div style="background-color: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto;">
                            <p>调用结果：</p>
                            <pre style="background-color: white; padding: 10px; border: 1px solid #dee2e6; border-radius: 4px; white-space: pre-wrap;">${JSON.stringify(data.result, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    resultPanel.innerHTML = `
                        <h4 style="color: #dc3545;">工具调用失败</h4>
                        <div style="background-color: #f8d7da; color: #721c24; padding: 10px; border-radius: 4px; border: 1px solid #f5c6cb;">
                            <strong>错误信息：</strong> ${data.error}
                        </div>
                    `;
                }
            }
        })
        .catch(error => {
            console.error('请求失败:', error);

            // 显示错误信息
            if (resultPanel) {
                resultPanel.innerHTML = `
                    <h4 style="color: #dc3545;">请求失败</h4>
                    <div style="background-color: #f8d7da; color: #721c24; padding: 10px; border-radius: 4px; border: 1px solid #f5c6cb;">
                        <strong>错误信息：</strong> ${error.message || error}
                    </div>
                `;
            }
        });
    }

    // 重置表单
    function resetForm() {
        document.getElementById('tool-name').value = '';

        // 清空参数容器，只保留一个默认参数对
        const container = document.getElementById('parameters-container');
        container.innerHTML = `
            <div class="param-pair" data-param-id="1">
                <div class="param-input-group">
                    <input type="text" class="param-key" placeholder="key" name="param_key_1">
                    <input type="text" class="param-value" placeholder="value" name="param_value_1">
                    <select class="param-type" name="param_type_1" onchange="handleTypeChange(this)">
                        <option value="text" selected>Text</option>
                        <option value="number">Number</option>
                        <option value="boolean">Boolean</option>
                        <option value="null">Null</option>
                    </select>
                    <button type="button" class="btn-remove-param" onclick="removeParameter(1)">×</button>
                </div>
            </div>
        `;

        // 重置计数器
        paramCount = 1;

        // 清空结果区域
        const resultPanel = document.querySelector('.right-panel');
        if (resultPanel) {
            resultPanel.innerHTML = 'Submit to get results.';
        }
    }

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        // 确保DOM已完全加载
        console.log('MCP工具调用表单初始化完成');
    });

</script>
<script type="text/javascript" src="{{ url_for('static', filename='js/_json.js') }}"></script>
</div>
</body>
</html>