<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Service Info - {{ serviceName | default('Unknown') }}</title>
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/_mcp_info.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/_json.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/basic_tabs.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/buttons.css') }}">
    
    <style>
        /* å³ä¾§æ ‡ç­¾é¡µå®¹å™¨ */
        .right-tabs-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        /* æ ‡ç­¾é¡µå¯¼èˆª */
        .tabs-navigation {
            display: flex;
            gap: 0;
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            flex-shrink: 0;
        }

        .tab-button {
            flex: 1;
            padding: 12px 20px;
            background-color: #f8f9fa;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #495057;
            transition: all 0.3s ease;
            position: relative;
            margin-bottom: -2px;
        }

        .tab-button:hover {
            background-color: #e9ecef;
            color: #212529;
        }

        .tab-button.active {
            background-color: #fff;
            color: #007bff;
            border-bottom: 2px solid #007bff;
        }

        /* æ ‡ç­¾é¡µå†…å®¹å®¹å™¨ */
        .tabs-content {
            flex: 1;
            overflow: hidden;
            position: relative;
            background-color: #fff;
        }

        /* æ ‡ç­¾é¡µé¢æ¿ */
        .tab-pane {
            display: none;
            height: 100%;
            overflow: hidden;
        }

        .tab-pane.active {
            display: block;
        }

        /* æ‰‹åŠ¨è°ƒç”¨å®¹å™¨ - å·¦å³å¸ƒå±€ */
        .manual-call-container {
            display: flex;
            height: 100%;
            overflow: hidden;
        }

        .manual-call-container .param-panel {
            flex: 1;
            border-right: 1px solid #ddd;
        }

        .manual-call-container .result-panel {
            flex: 1;
            padding: 10px;
            background-color: #fff;
            overflow-y: auto;
            line-height: 1.6;
            color: #555;
        }

        /* AIè°ƒç”¨å®¹å™¨ */
        .ai-call-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
            background-color: #fff;
        }

        /* å¯¹è¯åŒºåŸŸ */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #f8f9fa;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* æ¶ˆæ¯å®¹å™¨ */
        .chat-messages .message {
            display: flex;
            width: 100%;
            flex-shrink: 0;
            box-sizing: border-box;
        }

        .chat-messages .message.user-message {
            justify-content: flex-end;
        }

        .chat-messages .message.ai-message {
            justify-content: flex-start;
        }

        /* æ¶ˆæ¯æ°”æ³¡ */
        .chat-messages .message-bubble {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 12px;
            word-wrap: break-word;
            box-sizing: border-box;
        }

        .chat-messages .user-message .message-bubble {
            background-color: #007bff;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .chat-messages .ai-message .message-bubble.ai-tool {
            background-color: #e3f2fd;
            color: #1565c0;
            border-bottom-left-radius: 4px;
            border: 1px solid #bbdefb;
        }

        .chat-messages .ai-message .message-bubble.ai-response {
            background-color: #e8f5e9;
            color: #2e7d32;
            border-bottom-left-radius: 4px;
            border: 1px solid #c8e6c9;
        }

        .chat-messages .message-content {
            font-size: 14px;
            line-height: 1.2;
        }

        /* ç”¨æˆ·æ¶ˆæ¯å’ŒAIå“åº”æ¶ˆæ¯éœ€è¦ä¿ç•™æ¢è¡Œ */
        .chat-messages .user-message .message-content,
        .chat-messages .ai-response .message-content {
            white-space: pre-wrap;
        }

        /* å·¥å…·è°ƒç”¨ç‰¹æ®Šæ ·å¼ */
        .chat-messages .tool-call-info {
            background-color: #fff3e0;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 13px;
            border-left: 3px solid #ff9800;
        }

        .chat-messages .tool-call-info strong {
            display: block;
            margin-bottom: 4px;
            color: #e65100;
        }

        /* å·¥å…·è°ƒç”¨å†…å®¹æ ·å¼ä¼˜åŒ– - å‡å°‘çºµå‘é—´è· */
        .chat-messages .ai-tool .message-content {
            line-height: 1.3;
            white-space: normal; /* è¦†ç›–é»˜è®¤çš„ pre-wrapï¼Œé¿å…ä¿ç•™æ¢è¡Œç¬¦äº§ç”Ÿçš„é—´è· */
        }

        .chat-messages .ai-tool .message-content > div {
            margin-bottom: 6px;
            margin-top: 6px;
        }

        .chat-messages .ai-tool .message-content pre {
            margin: 0;
            line-height: 1.4;
            white-space: pre-wrap; /* åªåœ¨ pre æ ‡ç­¾å†…ä¿ç•™æ¢è¡Œ */
        }

        /* è¾“å…¥åŒºåŸŸ */
        .chat-input-area {
            flex-shrink: 0;
            padding: 16px;
            background-color: #fff;
            border-top: 1px solid #dee2e6;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .chat-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: none;
            min-height: 80px;
            max-height: 200px;
            box-sizing: border-box;
        }

        .chat-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .input-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .input-hint {
            font-size: 12px;
            color: #6c757d;
        }

        .btn-send-message {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-send-message:hover {
            background-color: #0056b3;
        }

        .btn-send-message:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-send-message svg {
            width: 16px;
            height: 16px;
        }

        /* åŠ è½½åŠ¨ç”» */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background-color: #007bff;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.4;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }
    </style>
</head>
<body style="margin: 0; padding: 0; width: 100%; height: 100vh; overflow: hidden; box-sizing: border-box;">
<div class="container_main" style="width: 100%; height: 100%; overflow: hidden; box-sizing: border-box;">
    <!-- ç¬¬ä¸€è¡Œï¼šæ ‡é¢˜ -->
    <header class="header-section">
        <h1>{{ serviceName | default('æ— å†…å®¹') }}</h1>
    </header>

    <!-- ç¬¬äºŒè¡Œï¼šå·¦å³å¸ƒå±€ -->
    <div class="main-content">

        <!-- å·¦ä¾§ï¼šæ–‡æœ¬åŒº (å¯æ»šåŠ¨) -->
         <div class="left-panel" style="width: 35%;">
            <pre><code style = "white-space: pre-wrap; word-break: break-word; font-size: clamp(14px, 1rem, 24px)">{{ serviceInfo }}</code></pre>
        </div>

        <!-- å³ä¾§ï¼šæ ‡ç­¾é¡µåŒºåŸŸ (64%å®½åº¦) -->
        <div class="right-tabs-container" style="width: 70%;">

            <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
            <div class="tabs-navigation">
                <button class="tab-button active" data-tab="manual" onclick="switchTab('manual')">
                    Manual Call
                </button>
                <button class="tab-button" data-tab="ai" onclick="switchTab('ai')">
                    AI Call
                </button>
            </div>

            <!-- æ ‡ç­¾é¡µå†…å®¹ -->
            <div class="tabs-content">

                <!-- æ ‡ç­¾é¡µ1: æ‰‹åŠ¨è°ƒç”¨ -->
                <div class="tab-pane active" id="tab-manual">
                    <div class="manual-call-container">
                        <!-- å·¦ä¾§ï¼šå‚æ•°å¡«æŠ¥åŒº -->
                        <form class="param-panel" id="tool-form">

                            <!-- å·¥å…·åç§°è¾“å…¥åŒºåŸŸ -->
                            <div class="tool-name-section">
                                <div class="form-group">
                                    <label for="tool-name">Tool Name</label>
                                    <input type="text" id="tool-name" name="tool_name" placeholder="Input tool name." required>
                                </div>
                            </div>

                            <!-- å‚æ•°åŒºåŸŸ -->
                            <div class="params-section">
                                <div class="section-header">
                                    <h4>Parameters</h4>
                                    <button type="button" class="btn-add-param" onclick="addParameter()">
                                        + Add Parameter
                                    </button>
                                </div>

                                <!-- å‚æ•°è¾“å…¥åŒºåŸŸ (å¯æ»šåŠ¨) -->
                                <div class="form-scroll-area">
                                    <div id="parameters-container">
                                        <!-- é»˜è®¤å‚æ•°å¯¹ -->
                                        <div class="param-pair" data-param-id="1">
                                            <div class="param-input-group">
                                                <input type="text" class="param-key" placeholder="key" name="param_key_1">
                                                <input type="text" class="param-value" placeholder="value" name="param_value_1">
                                                <select class="param-type" name="param_type_1" onchange="handleTypeChange(this)">
                                                    <option value="text" selected>Text</option>
                                                    <option value="number">Number</option>
                                                    <option value="boolean">Boolean</option>
                                                    <option value="null">Null</option>
                                                </select>
                                                <button type="button" class="btn-remove-param" onclick="removeParameter(1)">Ã—</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- æŒ‰é’®åŒºåŸŸ (å›ºå®šåœ¨åº•éƒ¨) -->
                            <div class="form-footer">
                                <button type="button" class="btn-basic btn-reset" onclick="resetForm()">Reset</button>
                                <button type="button" class="btn-basic btn-submit" onclick="submitForm()">Submit</button>
                            </div>

                        </form>

                        <!-- å³ä¾§ï¼šç»“æœåŒº (å¯æ»šåŠ¨) -->
                        <div class="result-panel">
                            {{ serviceResult | default('Submit to get results.') }}
                        </div>
                    </div>
                </div>

                <!-- æ ‡ç­¾é¡µ2: AIè°ƒç”¨ -->
                <div class="tab-pane" id="tab-ai">
                    <div class="ai-call-container">
                        <!-- å¯¹è¯åŒºåŸŸ (å¯æ»šåŠ¨) -->
                        <div class="chat-messages" id="chat-messages">
                            <!-- æ¬¢è¿æ¶ˆæ¯ -->
                            <div class="message ai-message">
                                <div class="message-bubble ai-response">
                                    <div class="message-content">Hello! I'm ready to help you call MCP tools. Describe what you want to do, and I'll use the available tools to assist you.</div>
                                </div>
                            </div>
                        </div>

                        <!-- è¾“å…¥åŒºåŸŸ (å›ºå®šåœ¨åº•éƒ¨) -->
                        <div class="chat-input-area">
                            <textarea
                                id="ai-input"
                                class="chat-input"
                                placeholder="Describe what you want to do..."
                                rows="3"
                                onkeydown="handleChatKeydown(event)"
                            ></textarea>
                            <div class="input-actions">
                                <span class="input-hint">Press Enter to send, Shift+Enter for new line</span>
                                <div style="display: flex; gap: 8px;">
                                    <button type="button" class="btn-send-message" onclick="clearChat()" style="background-color: #6c757d;">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <polyline points="3 6 5 6 21 6"></polyline>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                            <line x1="10" y1="11" x2="10" y2="17"></line>
                                            <line x1="14" y1="11" x2="14" y2="17"></line>
                                        </svg>
                                        Clear
                                    </button>
                                    <button type="button" class="btn-send-message" onclick="sendAIMessage()">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <line x1="22" y1="2" x2="11" y2="13"></line>
                                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                        </svg>
                                        Send
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>
</div>

<script>
    // æ ‡ç­¾é¡µåˆ‡æ¢å‡½æ•°
    function switchTab(tabName) {
        // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeçŠ¶æ€
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
        });

        // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
        document.querySelectorAll('.tab-pane').forEach(pane => {
            pane.classList.remove('active');
        });

        // æ¿€æ´»é€‰ä¸­çš„æ ‡ç­¾é¡µ
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        document.getElementById(`tab-${tabName}`).classList.add('active');
    }

    // AIèŠå¤©ç›¸å…³å‡½æ•°
    let isProcessing = false;

    // å¤„ç†é”®ç›˜äº‹ä»¶ï¼ˆEnterå‘é€ï¼ŒShift+Enteræ¢è¡Œï¼‰
    function handleChatKeydown(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendAIMessage();
        }
    }

    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    function addUserMessage(content) {
        const chatMessages = document.querySelector('#tab-ai .chat-messages');
        if (!chatMessages) {
            console.error('chat-messages container not found!');
            return;
        }
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message user-message';
        messageDiv.setAttribute('data-role', 'user');
        messageDiv.setAttribute('data-content', content);
        messageDiv.innerHTML = `
            <div class="message-bubble">
                <div class="message-content">${escapeHtml(content)}</div>
            </div>
        `;
        chatMessages.appendChild(messageDiv);
        scrollToBottom();
    }

    // æ·»åŠ AIå·¥å…·è°ƒç”¨æ¶ˆæ¯ï¼ˆæµ…è“è‰²ï¼‰
    function addAIToolMessage(toolName, parameters, result) {
        const chatMessages = document.querySelector('#tab-ai .chat-messages');
        if (!chatMessages) {
            console.error('chat-messages container not found!');
            return;
        }
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message ai-message';

        const paramsStr = JSON.stringify(parameters, null, 2);
        const resultStr = typeof result === 'string' ? result : JSON.stringify(result, null, 2);

        // å­˜å‚¨å…ƒæ•°æ®ç”¨äºå†å²è®°å½•
        messageDiv.setAttribute('data-role', 'tool-call');
        messageDiv.setAttribute('data-tool-name', toolName);
        messageDiv.setAttribute('data-parameters', JSON.stringify(parameters));
        messageDiv.setAttribute('data-result', JSON.stringify(result));

        messageDiv.innerHTML = `
            <div class="message-bubble ai-tool">
                <div class="tool-call-info">
                    <strong>ğŸ”§ Calling Tool: ${escapeHtml(toolName)}</strong>
                </div>
                <div class="message-content">
                    <div><strong>Parameters:</strong></div>
                    <pre style="background: rgba(0,0,0,0.05); padding: 8px; border-radius: 4px; overflow-x: auto;">${escapeHtml(paramsStr)}</pre>
                    <div><strong>Result:</strong></div>
                    <pre style="background: rgba(0,0,0,0.05); padding: 8px; border-radius: 4px; overflow-x: auto; white-space: pre-wrap;">${escapeHtml(resultStr)}</pre>
                </div>
            </div>
        `;
        chatMessages.appendChild(messageDiv);
        scrollToBottom();
    }

    // æ·»åŠ AIæ–‡æœ¬å“åº”æ¶ˆæ¯ï¼ˆæµ…ç»¿è‰²ï¼‰
    function addAIResponseMessage(content) {
        const chatMessages = document.querySelector('#tab-ai .chat-messages');
        if (!chatMessages) {
            console.error('chat-messages container not found!');
            return;
        }
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message ai-message';
        messageDiv.setAttribute('data-role', 'assistant');
        messageDiv.setAttribute('data-content', content);
        messageDiv.innerHTML = `
            <div class="message-bubble ai-response">
                <div class="message-content">${escapeHtml(content)}</div>
            </div>
        `;
        chatMessages.appendChild(messageDiv);
        scrollToBottom();
    }

    // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
    function showTypingIndicator() {
        const chatMessages = document.querySelector('#tab-ai .chat-messages');
        if (!chatMessages) {
            console.error('chat-messages container not found!');
            return;
        }

        // å…ˆç§»é™¤æ—§çš„åŠ è½½æŒ‡ç¤ºå™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        hideTypingIndicator();

        const indicatorDiv = document.createElement('div');
        indicatorDiv.className = 'message ai-message';
        indicatorDiv.id = 'typing-indicator';
        indicatorDiv.innerHTML = `
            <div class="message-bubble ai-response">
                <div class="typing-indicator">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        `;
        chatMessages.appendChild(indicatorDiv);
        scrollToBottom();
    }

    // éšè—åŠ è½½æŒ‡ç¤ºå™¨
    function hideTypingIndicator() {
        const indicator = document.getElementById('typing-indicator');
        if (indicator) {
            indicator.remove();
        }
    }

    // æ»šåŠ¨åˆ°åº•éƒ¨
    function scrollToBottom() {
        const chatMessages = document.getElementById('chat-messages');
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // HTMLè½¬ä¹‰
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // å‘é€AIæ¶ˆæ¯
    async function sendAIMessage() {
        if (isProcessing) {
            return;
        }

        const input = document.getElementById('ai-input');
        const message = input.value.trim();

        if (!message) {
            return;
        }
        //
        let lst_msg = getChatHistory();

        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        addUserMessage(message);

        // æ‰“å°å†å²å¯¹è¯ï¼Œç”¨äºè°ƒè¯•
        lst_msg.push({'role':'user','content':message});
        console.log(lst_msg);

        // æ¸…ç©ºè¾“å…¥æ¡†
        input.value = '';

        // ç¦ç”¨å‘é€
        isProcessing = true;
        const sendButtons = document.querySelectorAll('.btn-send-message');
        sendButtons.forEach(btn => btn.disabled = true);

        // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
        showTypingIndicator();

        // è·å–æœåŠ¡åç§°
        const serviceName = document.querySelector('.header-section h1').textContent;

        try {
            // è°ƒç”¨åç«¯æµå¼API
            const response = await fetch(`/api/services/${encodeURIComponent(serviceName)}/ai_chat_stream`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    messages: lst_msg
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            // è¯»å–æµå¼å“åº”
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                // è§£ç æ•°æ®å—
                buffer += decoder.decode(value, { stream: true });

                // æŒ‰è¡Œåˆ†å‰²ï¼Œå¤„ç†æ¯ä¸ª SSE äº‹ä»¶
                const lines = buffer.split('\n\n');
                buffer = lines.pop() || ''; // ä¿ç•™æœªå®Œæˆçš„è¡Œ

                for (const line of lines) {
                    if (!line.trim() || !line.startsWith('data: ')) continue;

                    // æå– JSON æ•°æ®
                    const jsonStr = line.substring(6).trim();
                    if (!jsonStr) continue;

                    try {
                        const data = JSON.parse(jsonStr);

                        // æ ¹æ®æ¶ˆæ¯ç±»å‹å¤„ç†
                        if (data.type === 'tool_call') {
                            // æ˜¾ç¤ºå·¥å…·è°ƒç”¨ç»“æœ
                            addAIToolMessage(data.tool_name, data.parameters, data.result);
                            // é‡æ–°å°†åŠ è½½åŠ¨ç”»æ”¾åˆ°æœ€ä¸‹é¢
                            showTypingIndicator();
                        } else if (data.type === 'response') {
                            // æ˜¾ç¤ºAIå“åº”ï¼Œéšè—åŠ è½½åŠ¨ç”»
                            addAIResponseMessage(data.content);
                            hideTypingIndicator();
                        } else if (data.type === 'error') {
                            // æ˜¾ç¤ºé”™è¯¯ï¼Œéšè—åŠ è½½åŠ¨ç”»
                            addAIResponseMessage(`Error: ${data.message}`);
                            hideTypingIndicator();
                        } else if (data.type === 'done') {
                            // æµç»“æŸï¼Œéšè—åŠ è½½åŠ¨ç”»
                            hideTypingIndicator();
                            console.log('Stream completed');
                        }
                    } catch (e) {
                        console.error('Failed to parse SSE data:', jsonStr, e);
                    }
                }
            }

            // ç¡®ä¿åœ¨æµç»“æŸåéšè—åŠ è½½åŠ¨ç”»ï¼ˆé˜²æ­¢æŸäº›æƒ…å†µä¸‹æ²¡æœ‰æ”¶åˆ°doneä¿¡å·ï¼‰
            hideTypingIndicator();
        } catch (error) {
            hideTypingIndicator();
            console.error('AI chat error:', error);
            addAIResponseMessage(`Error: ${error.message}`);
        } finally {
            // æ¢å¤å‘é€æŒ‰é’®
            isProcessing = false;
            const sendButtons = document.querySelectorAll('.btn-send-message');
            sendButtons.forEach(btn => btn.disabled = false);
        }
    }

    // æ¸…ç©ºå¯¹è¯
    function clearChat() {
        const chatMessages = document.querySelector('#tab-ai .chat-messages');
        if (!chatMessages) {
            console.error('chat-messages container not found!');
            return;
        }

        // æ¸…ç©ºæ‰€æœ‰æ¶ˆæ¯ï¼Œä¿ç•™æ¬¢è¿æ¶ˆæ¯
        chatMessages.innerHTML = `
            <div class="message ai-message">
                <div class="message-bubble ai-response">
                    <div class="message-content">Hello! I'm ready to help you call MCP tools. Describe what you want to do, and I'll use the available tools to assist you.</div>
                </div>
            </div>
        `;

        console.log('Chat cleared');
    }

    // è·å–å¯¹è¯å†å²ï¼ˆOpenAI APIæ ¼å¼ï¼‰
    function getChatHistory() {
        const chatMessages = document.querySelector('#tab-ai .chat-messages');
        if (!chatMessages) {
            console.error('chat-messages container not found!');
            return [];
        }

        const history = [];
        const messages = chatMessages.querySelectorAll('.message');

        // è·³è¿‡æ¬¢è¿æ¶ˆæ¯ï¼ˆæ²¡æœ‰data-roleå±æ€§çš„ï¼‰
        messages.forEach(msg => {
            const role = msg.getAttribute('data-role');
            if (!role) return; // è·³è¿‡æ¬¢è¿æ¶ˆæ¯

            if (role === 'user') {
                // ç”¨æˆ·æ¶ˆæ¯
                const content = msg.getAttribute('data-content');
                history.push({
                    role: 'user',
                    content: content
                });
            } else if (role === 'assistant') {
                // AIå“åº”æ¶ˆæ¯
                try{
                    const content = msg.getAttribute('data-content');
                    history.push({
                        role: 'assistant',
                        content: content
                    });
                }
                catch(err){
                    //
                }
            } else if (role === 'tool-call') {
                try{
                    // å·¥å…·è°ƒç”¨æ¶ˆæ¯ - éœ€è¦æ‹†åˆ†ä¸ºassistantçš„toolè°ƒç”¨å’Œtoolçš„å“åº”
                    const toolName = msg.getAttribute('data-tool-name');
                    const parameters = msg.getAttribute('data-parameters');
                    const result = msg.getAttribute('data-result');

                    // ç”Ÿæˆå”¯ä¸€çš„tool_call_id
                    const toolCallId = `call_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

                    // æ·»åŠ assistantçš„toolè°ƒç”¨
                    /* history.push({
                        role: 'assistant',
                        content: null,
                        tool_calls: [
                            {
                                id: toolCallId,
                                type: 'function',
                                function: {
                                    name: toolName,
                                    arguments: JSON.stringify(JSON.parse(parameters))
                                }
                            }
                        ]
                    }); 
                    */
                    // æ·»åŠ toolçš„å“åº”
                    // history.push({
                    //    role: 'tool',
                    //    tool_call_id: toolCallId,
                    //    content: JSON.stringify(JSON.parse(result))
                    // });
                }
                catch{

                }
            }
        });

        return history;
    }

    // å¯¼å‡ºå¯¹è¯å†å²åˆ°æ§åˆ¶å°ï¼ˆæ–¹ä¾¿è°ƒè¯•ï¼‰
    function exportChatHistory() {
        const history = getChatHistory();
        console.log('Chat History (OpenAI format):');
        console.log(JSON.stringify(history, null, 2));
        return history;
    }

    // å‚æ•°è®¡æ•°å™¨
    let paramCount = 1;

    // æ·»åŠ å‚æ•°å¯¹
    function addParameter() {
        paramCount++;
        const container = document.getElementById('parameters-container');

        const paramPair = document.createElement('div');
        paramPair.className = 'param-pair';
        paramPair.setAttribute('data-param-id', paramCount);

        paramPair.innerHTML = `
            <div class="param-input-group">
                <input type="text" class="param-key" placeholder="key" name="param_key_${paramCount}">
                <input type="text" class="param-value" placeholder="value" name="param_value_${paramCount}">
                <select class="param-type" name="param_type_${paramCount}" onchange="handleTypeChange(this)">
                    <option value="text" selected>Text</option>
                    <option value="number">Number</option>
                    <option value="boolean">Boolean</option>
                    <option value="null">Null</option>
                </select>
                <button type="button" class="btn-remove-param" onclick="removeParameter(${paramCount})">Ã—</button>
            </div>
        `;

        container.appendChild(paramPair);
    }

    // ç§»é™¤å‚æ•°å¯¹
    function removeParameter(paramId) {
        const paramPair = document.querySelector(`[data-param-id="${paramId}"]`);
        if (paramPair) {
            paramPair.remove();
        }
    }

    // å¤„ç†ç±»å‹é€‰æ‹©å˜åŒ–
    function handleTypeChange(selectElement) {
        const paramInputGroup = selectElement.closest('.param-input-group');
        const valueInput = paramInputGroup.querySelector('.param-value');
        const selectedType = selectElement.value;

        if (selectedType === 'null') {
            // Nullç±»å‹ï¼šç¦ç”¨è¾“å…¥æ¡†å¹¶æ˜¾ç¤º"-"
            valueInput.value = '-';
            valueInput.disabled = true;
            valueInput.style.backgroundColor = '#f5f5f5';
            valueInput.style.cursor = 'not-allowed';
        } else {
            // å…¶ä»–ç±»å‹ï¼šæ¢å¤è¾“å…¥æ¡†
            if (valueInput.value === '-') {
                valueInput.value = '';
            }
            valueInput.disabled = false;
            valueInput.style.backgroundColor = '';
            valueInput.style.cursor = '';
        }
    }

    // æ”¶é›†è¡¨å•æ•°æ®å¹¶è½¬æ¢ä¸ºJSON
    function collectFormData() {
        const toolName = document.getElementById('tool-name').value.trim();

        const parameters = {};
        const paramPairs = document.querySelectorAll('.param-pair');

        paramPairs.forEach(pair => {
            const key = pair.querySelector('.param-key').value.trim();
            const valueInput = pair.querySelector('.param-value');
            const typeSelect = pair.querySelector('.param-type');

            if (key) {
                const paramType = typeSelect ? typeSelect.value : 'text';

                // æ ¹æ®ç±»å‹è½¬æ¢å€¼
                let value;
                if (paramType === 'null') {
                    value = null;
                } else if (paramType === 'boolean') {
                    const rawValue = valueInput.value.trim().toLowerCase();
                    if (rawValue === 'true' || rawValue === '1' || rawValue === 'yes') {
                        value = true;
                    } else if (rawValue === 'false' || rawValue === '0' || rawValue === 'no') {
                        value = false;
                    } else {
                        // å¦‚æœè¾“å…¥ä¸æ˜ç¡®ï¼Œé»˜è®¤ä¸º trueï¼ˆéç©ºå­—ç¬¦ä¸²ï¼‰æˆ– false
                        value = rawValue.length > 0;
                    }
                } else if (paramType === 'number') {
                    const rawValue = valueInput.value.trim();
                    if (rawValue) {
                        value = Number(rawValue);
                    } else {
                        value = 0;
                    }
                } else {
                    // text ç±»å‹ï¼Œç›´æ¥ä½¿ç”¨å­—ç¬¦ä¸²å€¼
                    value = valueInput.value.trim();
                }

                parameters[key] = value;
            }
        });

        return {
            tool_name: toolName,
            parameters: parameters
        };
    }

    // æäº¤è¡¨å•
    function submitForm() {
        const formData = collectFormData();

        // éªŒè¯å·¥å…·åç§°
        if (!formData.tool_name) {
            alert('è¯·è¾“å…¥å·¥å…·åç§°ï¼');
            document.getElementById('tool-name').focus();
            return;
        }

        // è·å–æœåŠ¡åç§°ï¼ˆä»é¡µé¢æ ‡é¢˜ä¸­è·å–ï¼‰
        const serviceName = document.querySelector('.header-section h1').textContent;

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const resultPanel = document.querySelector('.result-panel');
        if (resultPanel) {
            resultPanel.innerHTML = `
                <div style="padding: 20px; text-align: center;">
                    <div style="color: #007bff; font-size: 16px;">æ­£åœ¨è°ƒç”¨å·¥å…·...</div>
                    <div style="margin-top: 10px; font-size: 14px; color: #666;">è¯·ç¨å€™</div>
                </div>
            `;
        }

        // å‘é€è¯·æ±‚åˆ°æœåŠ¡å™¨
        fetch(`/api/services/${encodeURIComponent(serviceName)}/call_tool`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || `HTTP ${response.status}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('æœåŠ¡å™¨å“åº”:', data);

            // æ˜¾ç¤ºç»“æœ
            if (resultPanel) {
                if (data.success) {
                    resultPanel.innerHTML = `
                        <h4 style="color: #28a745;">å·¥å…·è°ƒç”¨æˆåŠŸ</h4>
                        <div style="background-color: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto;">
                            <p>è°ƒç”¨ç»“æœï¼š</p>
                            <pre style="background-color: white; padding: 10px; border: 1px solid #dee2e6; border-radius: 4px; white-space: pre-wrap;">${JSON.stringify(data.result, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    resultPanel.innerHTML = `
                        <h4 style="color: #dc3545;">å·¥å…·è°ƒç”¨å¤±è´¥</h4>
                        <div style="background-color: #f8d7da; color: #721c24; padding: 10px; border-radius: 4px; border: 1px solid #f5c6cb;">
                            <strong>é”™è¯¯ä¿¡æ¯ï¼š</strong> ${data.error}
                        </div>
                    `;
                }
            }
        })
        .catch(error => {
            console.error('è¯·æ±‚å¤±è´¥:', error);

            // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            if (resultPanel) {
                resultPanel.innerHTML = `
                    <h4 style="color: #dc3545;">è¯·æ±‚å¤±è´¥</h4>
                    <div style="background-color: #f8d7da; color: #721c24; padding: 10px; border-radius: 4px; border: 1px solid #f5c6cb;">
                        <strong>é”™è¯¯ä¿¡æ¯ï¼š</strong> ${error.message || error}
                    </div>
                `;
            }
        });
    }

    // é‡ç½®è¡¨å•
    function resetForm() {
        document.getElementById('tool-name').value = '';

        // æ¸…ç©ºå‚æ•°å®¹å™¨ï¼Œåªä¿ç•™ä¸€ä¸ªé»˜è®¤å‚æ•°å¯¹
        const container = document.getElementById('parameters-container');
        container.innerHTML = `
            <div class="param-pair" data-param-id="1">
                <div class="param-input-group">
                    <input type="text" class="param-key" placeholder="key" name="param_key_1">
                    <input type="text" class="param-value" placeholder="value" name="param_value_1">
                    <select class="param-type" name="param_type_1" onchange="handleTypeChange(this)">
                        <option value="text" selected>Text</option>
                        <option value="number">Number</option>
                        <option value="boolean">Boolean</option>
                        <option value="null">Null</option>
                    </select>
                    <button type="button" class="btn-remove-param" onclick="removeParameter(1)">Ã—</button>
                </div>
            </div>
        `;

        // é‡ç½®è®¡æ•°å™¨
        paramCount = 1;

        // æ¸…ç©ºç»“æœåŒºåŸŸ
        const resultPanel = document.querySelector('.result-panel');
        if (resultPanel) {
            resultPanel.innerHTML = 'Submit to get results.';
        }
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        // ç¡®ä¿DOMå·²å®Œå…¨åŠ è½½
        console.log('MCPå·¥å…·è°ƒç”¨è¡¨å•åˆå§‹åŒ–å®Œæˆ');
    });

</script>
<script type="text/javascript" src="{{ url_for('static', filename='js/_json.js') }}"></script>
</div>
</body>
</html>