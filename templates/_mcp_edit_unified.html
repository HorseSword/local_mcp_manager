<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        {% if edit_type == 'service' %}Edit MCP Service - {{ service_name }}{% elif edit_type == 'add_service' %}Add New MCP Service{% else %}{{ mode | default('Edit') }} MCP Configuration{% endif %}
    </title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/_user_edit.css') }}">
    <style>
    
    </style>
</head>
<body style="overflow: hidden;">
<div class="mcp-edit-container">
    <!-- 头部 -->
    <div class="mcp-edit-header">
        <div>
            {% if edit_type == 'service' %}
            <div class="mcp-edit-title">Edit MCP Service</div>
            <div class="mcp-edit-subtitle">
                <div class="mcp-edit-info">
                    <div class="info-item">
                        <span class="info-label">Service Name:</span> {{ service_name }}
                    </div>
                    <div class="info-item">
                        <span class="info-label">Service ID:</span> {{ service_id }}
                    </div>
                </div>
            </div>
            {% elif edit_type == 'add_service' %}
            <div class="mcp-edit-title">Add New MCP Service</div>
            <div class="mcp-edit-subtitle">
                <div class="mcp-edit-info">
                    <div class="info-item">
                        <span class="info-label">Info:</span> Edit the new service configuration below. The service will be added to your existing configuration.
                    </div>
                </div>
            </div>
            {% else %}
            <div class="mcp-edit-title">{{ mode | default('Edit') }} MCP Configuration</div>
            {% endif %}
        </div>
        <div class="mcp-edit-actions">
            <button class="mcp-edit-btn mcp-edit-btn-basic" onclick="formatJSON()">Format JSON</button>
            <button class="mcp-edit-btn mcp-edit-btn-basic" onclick="resetToOriginal()">Reset</button>
            <button class="mcp-edit-btn mcp-edit-btn-success" onclick="saveConfiguration()">Save {% if edit_type == 'service' %}Service{% elif edit_type == 'add_service' %}New Service{% else %}Configuration{% endif %}</button>
            {% if edit_type == 'service' %}
            <button class="mcp-edit-btn mcp-edit-btn-delete" onclick="deleteService()">Delete MCP</button>
            {% endif %}
            <!-- <button class="mcp-edit-btn mcp-edit-btn-basic" onclick="closeEditor()">Close</button> -->
        </div>
    </div>

    <!-- 主要内容区域 -->
    <div class="mcp-edit-content">
        <!-- 左侧编辑区域 -->
        <div class="mcp-edit-editor-section">
            <!-- 编辑器头部 -->
            <div class="mcp-edit-editor-header">
                <div class="mcp-edit-editor-title">{% if edit_type == 'service' %}Service Configuration{% else %}mcp_conf.json{% endif %}</div>
                <div id="json-status" class="mcp-edit-json-status mcp-edit-status-valid">Valid JSON</div>
            </div>

            <!-- JSON 编辑器 -->
            <textarea id="json-editor" class="mcp-edit-json-editor" placeholder="{% if edit_type == 'service' %}Enter service configuration here...{% elif edit_type == 'add_service' %}Enter new service configuration here...{% else %}Enter your MCP configuration here...{% endif %}">{{ config_content | default('') }}</textarea>

            <!-- 错误消息 -->
            <div id="error-message" class="mcp-edit-error-message"></div>
        </div>

        <!-- 右侧帮助区域 -->
        <div class="mcp-edit-help-section">
            <div class="mcp-edit-help-header">Configuration Reference</div>
            <div class="mcp-edit-help-content">
                {% if edit_type == 'service' or edit_type == 'add_service' %}
                <h4>{% if edit_type == 'add_service' %}New {% endif %}Service Configuration Format:</h4>
                <pre>{
    "name": "Display Name",
    "description": "Service description",
    "command": "uv/npx/python",
    "args": ["run", "script.py"],
    "cwd": "working/directory",
    "out_port": 17001,
    "isActive": true,
    "env": {"VAR": "value"},
    "type": "stdio/sse/streamableHttp",
    "url": "http://localhost:port/sse",
    "headers": {},
    "host": "127.0.0.1"
}</pre>
                {% if edit_type == 'add_service' %}
                <p><strong>Required fields:</strong> out_port (unique for each service)</p>
                <p><strong>Optional fields:</strong> name, description, command, args, cwd, env, type, url, headers, isActive, host</p>
                <p><strong>Note:</strong> The service name will be used as the service ID. Make sure it's unique.</p>
                {% else %}
                <p><strong>Required fields:</strong> out_port (unique for each service)</p>
                <p><strong>Optional fields:</strong> cwd, env, type, url, headers, isActive, host, name, description, command, args</p>
                {% endif %}
                {% else %}
                <h4>Configuration Format:</h4>
                <pre>{
    "mcpServers": {
        "service_id": {
            "name": "Display Name",
            "description": "Service description",
            "command": "uv/npx/python",
            "args": ["run", "script.py"],
            "cwd": "working/directory",
            "out_port": 17001,
            "isActive": true,
            "env": {"VAR": "value"},
            "type": "stdio/sse/streamableHttp",
            "url": "http://localhost:port/sse",
            "headers": {}
        }
    }
}</pre>
                <p><strong>Required fields:</strong> out_port (unique for each service)</p>
                <p><strong>Optional fields:</strong> cwd, env, type, url, headers, isActive</p>
                {% endif %}

                <h4>Field Descriptions:</h4>
                <ul>
                    <li><strong>name:</strong> Display name for the service</li>
                    <li><strong>description:</strong> Brief description of what the service does</li>
                    <li><strong>command:</strong> Command to run the service (uv, npx, python, etc.)</li>
                    <li><strong>args:</strong> Array of arguments for the command</li>
                    <li><strong>cwd:</strong> Working directory for the service</li>
                    <li><strong>out_port:</strong> Unique port number for the service</li>
                    <li><strong>isActive:</strong> Whether the service should be auto-started</li>
                    <li><strong>env:</strong> Environment variables for the service</li>
                    <li><strong>type:</strong> Service type: stdio, sse, or streamableHttp</li>
                    <li><strong>url:</strong> URL for SSE or HTTP services</li>
                    <li><strong>headers:</strong> Additional HTTP headers</li>
                    <li><strong>host:</strong> Host address for the service</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
    console.log("MCP Edit page loaded - Type: {% if edit_type == 'service' %}Service{% else %}Configuration{% endif %}");

    // 简单的全局变量
    let originalContent = '';
    let currentContent = '';
    {% if edit_type == 'service' %}
    const serviceName = '{{ service_name }}';
    const editType = 'service';
    {% elif edit_type == 'add_service' %}
    const editType = 'add_service';
    {% else %}
    const editType = 'config';
    {% endif %}

    // 获取当前编辑器内容
    function getCurrentContent() {
        const editor = document.getElementById('json-editor');
        return editor ? editor.value : currentContent;
    }

    // 验证 JSON 格式
    function validateJSON() {
        const statusElement = document.getElementById('json-status');
        const errorElement = document.getElementById('error-message');
        const currentContent = getCurrentContent();

        try {
            if (currentContent.trim() === '') {
                statusElement.textContent = 'Empty';
                statusElement.className = 'mcp-edit-json-status mcp-edit-status-invalid';
                errorElement.style.display = 'none';
                return false;
            }

            const parsed = JSON.parse(currentContent);

            // 检查必需字段
            {% if edit_type == 'service' %}
            if (!parsed.out_port) {
                throw new Error('Missing required field: out_port');
            }
            {% endif %}

            statusElement.textContent = 'Valid JSON';
            statusElement.className = 'mcp-edit-json-status mcp-edit-status-valid';
            errorElement.style.display = 'none';
            return true;
        } catch (error) {
            statusElement.textContent = 'Invalid JSON';
            statusElement.className = 'mcp-edit-json-status mcp-edit-status-invalid';
            errorElement.textContent = 'JSON Syntax Error: ' + error.message;
            errorElement.style.display = 'block';
            return false;
        }
    }

    // 格式化 JSON
    function formatJSON() {
        try {
            const currentContent = getCurrentContent();
            if (currentContent.trim() === '') {
                alert('No content to format');
                return;
            }

            const parsed = JSON.parse(currentContent);
            const formatted = JSON.stringify(parsed, null, 2);
            const editor = document.getElementById('json-editor');
            editor.value = formatted;
            validateJSON();
        } catch (error) {
            alert('Cannot format invalid JSON: ' + error.message);
        }
    }

    // 重置到原始内容
    function resetToOriginal() {
        if (confirm('Are you sure you want to reset to the original configuration? All changes will be lost.')) {
            const editor = document.getElementById('json-editor');
            editor.value = originalContent;
            validateJSON();
        }
    }

    // 删除
    async function deleteService() {
        let r = confirm('Are you sure to DELETE this MCP service?')
        if (r) {
            url = `/api/services/${encodeURIComponent(serviceName)}/delete`;

            response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/plain',
                },
            });
        }
    }

    // 保存配置
    async function saveConfiguration() {
        if (!validateJSON()) {
            alert('Please fix JSON syntax errors before saving.');
            return;
        }

        try {
            const currentContent = getCurrentContent();
            let response, url;

            {% if edit_type == 'service' %}
            url = `/api/services/${encodeURIComponent(serviceName)}/save`;
            {% elif edit_type == 'add_service' %}
            url = '/api/config/add-service';
            {% else %}
            url = '/api/config/save';
            {% endif %}

            response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/plain',
                },
                body: currentContent
            });

            const result = await response.json();

            if (result.success) {
                alert('{% if edit_type == "service" %}Service configuration saved successfully!{% elif edit_type == "add_service" %}New service added successfully!{% else %}Configuration saved successfully!{% endif %}');
                originalContent = currentContent;

                // 通知父页面刷新
                if (window.parent) {
                    const messageType = {% if edit_type == 'service' %}'MCP_SERVICE_SAVED'{% elif edit_type == 'add_service' %}'MCP_CONFIG_SAVED'{% else %}'MCP_CONFIG_SAVED'{% endif %};
                    const messageData = {
                        type: messageType
                    };

                    {% if edit_type == 'service' %}
                    messageData.serviceName = serviceName;
                    {% endif %}

                    window.parent.postMessage(messageData, '*');
                }
            } else {
                alert('Failed to save {% if edit_type == "service" %}service{% elif edit_type == "add_service" %}new service{% else %}configuration{% endif %}: ' + result.error);
            }
        } catch (error) {
            alert('Error saving {% if edit_type == "service" %}service{% elif edit_type == "add_service" %}new service{% else %}configuration{% endif %}: ' + error.message);
        }
    }

    // 关闭编辑器
    function closeEditor() {
        const currentContent = getCurrentContent();
        if (currentContent !== originalContent) {
            if (confirm('You have unsaved changes. Are you sure you want to close?')) {
                // 通知父页面关闭模态框
                if (window.parent) {
                    window.parent.postMessage({
                        type: 'MCP_CLOSE_MODAL'
                    }, '*');
                }
            }
        } else {
            // 通知父页面关闭模态框
            if (window.parent) {
                window.parent.postMessage({
                    type: 'MCP_CLOSE_MODAL'
                }, '*');
            }
        }
    }

    // 初始化
    document.addEventListener('DOMContentLoaded', function() {
        const editor = document.getElementById('json-editor');
        if (editor) {
            originalContent = editor.value;
            currentContent = originalContent;

            // 监听内容变化
            editor.addEventListener('input', function() {
                currentContent = this.value;
                validateJSON();
            });

            // 初始验证
            validateJSON();
        }

        console.log('MCP Edit page initialized - Type:', editType, {% if edit_type == 'service' %}'Service:', serviceName{% endif %});
    });

    // 键盘快捷键
    document.addEventListener('keydown', function(e) {
        // Ctrl+S 保存
        if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            saveConfiguration();
        }
        // Ctrl+F 格式化
        if (e.ctrlKey && e.key === 'f') {
            e.preventDefault();
            formatJSON();
        }
        // Escape 关闭
        if (e.key === 'Escape') {
            closeEditor();
        }
    });
</script>
</body>
</html>