<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        {% if edit_type == 'service' %}Edit MCP Service - {{ service_name }}{% elif edit_type == 'add_service' %}Add New MCP Service{% else %}{{ mode | default('Edit') }} MCP Configuration{% endif %}
    </title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/_user_edit.css') }}">
    <style>
        .template-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .template-selector label {
            font-weight: bold;
            color: #333;
            white-space: nowrap;
        }
        .template-selector select {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            background-color: white;
            cursor: pointer;
        }
        .template-selector select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }
        .template-description {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body style="overflow: hidden;">
<div class="mcp-edit-container">
    <!-- 头部 -->
    <div class="mcp-edit-header">
        <div>
            {% if edit_type == 'service' %}
            <div class="mcp-edit-title">Edit MCP Service</div>
            <div class="mcp-edit-subtitle">
                <div class="mcp-edit-info">
                    <div class="info-item">
                        <span class="info-label">Service Name:</span> {{ service_name }}
                    </div>
                    <div class="info-item">
                        <span class="info-label">Service ID:</span> {{ service_id }}
                    </div>
                </div>
            </div>
            {% elif edit_type == 'add_service' %}
            <div class="mcp-edit-title">Add New MCP Service</div>
            <div class="mcp-edit-subtitle">
                <div class="mcp-edit-info">
                    <div class="info-item">
                        <span class="info-label">Info:</span> Select a template and edit the configuration below.
                    </div>
                </div>
            </div>
            {% else %}
            <div class="mcp-edit-title">{{ mode | default('Edit') }} MCP Configuration</div>
            {% endif %}
        </div>
        <div class="mcp-edit-actions">
            <button class="mcp-edit-btn mcp-edit-btn-basic" onclick="formatJSON()">Format JSON</button>
            <button class="mcp-edit-btn mcp-edit-btn-basic" onclick="resetToOriginal()">Reset</button>
            <button class="mcp-edit-btn mcp-edit-btn-success" onclick="saveConfiguration()">Save {% if edit_type == 'service' %}Service{% elif edit_type == 'add_service' %}New Service{% else %}Configuration{% endif %}</button>
            {% if edit_type == 'service' %}
            <button class="mcp-edit-btn mcp-edit-btn-delete" onclick="deleteService()">Delete MCP</button>
            {% endif %}
        </div>
    </div>

    <!-- 主要内容区域 -->
    <div class="mcp-edit-content">
        <!-- 左侧编辑区域 -->
        <div class="mcp-edit-editor-section">
            <!-- 模板选择器 (仅新增服务时显示) -->
            {% if edit_type == 'add_service' %}
            <div class="template-selector">
                <label for="template-select">Template:</label>
                <select id="template-select" onchange="applyTemplate()">
                    <option value="" disabled selected>-- Select a template --</option>
                    <option value="stdio-python">stdio (Python/uv)</option>
                    <option value="stdio-npx">stdio (npx/Node.js)</option>
                    <option value="http-sse">HTTP/SSE</option>
                </select>
            </div>
            {% endif %}

            <!-- 编辑器头部 -->
            <div class="mcp-edit-editor-header">
                <div class="mcp-edit-editor-title">{% if edit_type == 'service' %}Service Configuration{% else %}mcp_conf.json{% endif %}</div>
                <div id="json-status" class="mcp-edit-json-status mcp-edit-status-valid">Valid JSON</div>
            </div>

            <!-- JSON 编辑器 -->
            <textarea id="json-editor" class="mcp-edit-json-editor" placeholder="{% if edit_type == 'service' %}Enter service configuration here...{% elif edit_type == 'add_service' %}Select a template above or enter service configuration here...{% else %}Enter your MCP configuration here...{% endif %}">{{ config_content | default('') }}</textarea>

            <!-- 错误消息 -->
            <div id="error-message" class="mcp-edit-error-message"></div>
        </div>

        <!-- 右侧帮助区域 -->
        <div class="mcp-edit-help-section">
            <div class="mcp-edit-help-header">Configuration Reference</div>
            <div class="mcp-edit-help-content" id="help-content">
                {% if edit_type == 'service' or edit_type == 'add_service' %}
                <div id="help-default">
                    <h4>Select a Template</h4>
                    <p>Select a template from the dropdown above to see the configuration format and required fields.</p>

                    <h4>Template Types:</h4>
                    <ul>
                        <li><strong>stdio (Python/uv):</strong> For Python-based MCP servers using uv or uv</li>
                        <li><strong>stdio (npx):</strong> For Node.js-based MCP servers using npx</li>
                        <li><strong>HTTP/SSE:</strong> For MCP servers exposed via HTTP or Server-Sent Events</li>
                    </ul>

                    <h4>Common Fields:</h4>
                    <ul>
                        <li><strong>name:</strong> Display name (optional)</li>
                        <li><strong>description:</strong> Service description (optional)</li>
                        <li><strong>out_port:</strong> Unique port number (required)</li>
                        <li><strong>is_enabled:</strong> Auto-start on manager start (optional, default: true)</li>
                    </ul>
                </div>
                {% else %}
                <h4>Configuration Format:</h4>
                <pre>{
    "mcpServers": {
        "service_id": {
            "name": "Display Name",
            "description": "Service description",
            "command": "uv/npx/python",
            "args": ["run", "script.py"],
            "cwd": "working/directory",
            "out_port": 17001,
            "is_enabled": true,
            "env": {"VAR": "value"},
            "type": "stdio/sse/streamableHttp",
            "url": "http://localhost:port/sse",
            "headers": {}
        }
    }
}</pre>
                <p><strong>Required fields:</strong> out_port (unique for each service)</p>
                <p><strong>Optional fields:</strong> cwd, env, type, url, headers, is_enabled</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    console.log("MCP Edit page loaded - Type: {% if edit_type == 'service' %}Service{% else %}Configuration{% endif %}");

    // Template definitions
    const templates = {
        'stdio-python': {
            name: 'stdio (Python/uv)',
            config: {
                name: "My Python MCP",
                description: "Description of your Python MCP service",
                command: "uv",
                args: ["run", "your-package-name"],
                cwd: "D:/path/to/your/project",
                out_port: 17001,
                is_enabled: true,
                env: {},
                type: "stdio",
                host: "127.0.0.1"
            },
            help: `
                <h4>stdio (Python/uv) Configuration</h4>
                <pre>{
    "name": "My Python MCP",
    "description": "Description of your Python MCP service",
    "command": "uv",
    "args": ["run", "your-package-name"],
    "cwd": "D:/path/to/your/project",
    "out_port": 17001,
    "is_enabled": true,
    "env": {},
    "type": "stdio",
    "host": "127.0.0.1"
}</pre>
                <p><strong>Required fields:</strong></p>
                <ul>
                    <li><strong>out_port:</strong> Unique port number (17001-17999 recommended)</li>
                    <li><strong>command:</strong> Command to run (usually "uv" or "python")</li>
                    <li><strong>args:</strong> Array of arguments (e.g., ["run", "package-name"] for uv)</li>
                    <li><strong>cwd:</strong> Working directory (important for Python projects)</li>
                </ul>
                <p><strong>Optional fields:</strong></p>
                <ul>
                    <li><strong>name:</strong> Display name</li>
                    <li><strong>description:</strong> Service description</li>
                    <li><strong>is_enabled:</strong> Auto-start (default: true)</li>
                    <li><strong>env:</strong> Environment variables (e.g., {"API_KEY": "xxx"})</li>
                    <li><strong>host:</strong> Bind address (default: "127.0.0.1")</li>
                </ul>
                <p><strong>Examples:</strong></p>
                <ul>
                    <li>uv: <code>{"command": "uv", "args": ["run", "mcp-server-git"]}</code></li>
                    <li>python: <code>{"command": "python", "args": ["server.py"], "cwd": "D:/project"}</code></li>
                </ul>
            `
        },
        'stdio-npx': {
            name: 'stdio (npx/Node.js)',
            config: {
                name: "My Node.js MCP",
                description: "Description of your Node.js MCP service",
                command: "npx",
                args: ["-y", "@modelcontextprotocol/server-your-package"],
                out_port: 17002,
                is_enabled: true,
                env: {},
                type: "stdio",
                host: "127.0.0.1"
            },
            help: `
                <h4>stdio (npx/Node.js) Configuration</h4>
                <pre>{
    "name": "My Node.js MCP",
    "description": "Description of your Node.js MCP service",
    "command": "npx",
    "args": ["-y", "@modelcontextprotocol/server-your-package"],
    "out_port": 17002,
    "is_enabled": true,
    "env": {},
    "type": "stdio",
    "host": "127.0.0.1"
}</pre>
                <p><strong>Required fields:</strong></p>
                <ul>
                    <li><strong>out_port:</strong> Unique port number (17001-17999 recommended)</li>
                    <li><strong>command:</strong> Usually "npx"</li>
                    <li><strong>args:</strong> Array of arguments (e.g., ["-y", "@modelcontextprotocol/server-xxx"])</li>
                </ul>
                <p><strong>Optional fields:</strong></p>
                <ul>
                    <li><strong>name:</strong> Display name</li>
                    <li><strong>description:</strong> Service description</li>
                    <li><strong>is_enabled:</strong> Auto-start (default: true)</li>
                    <li><strong>env:</strong> Environment variables</li>
                    <li><strong>host:</strong> Bind address (default: "127.0.0.1")</li>
                </ul>
                <p><strong>Examples:</strong></p>
                <ul>
                    <li>GitHub: <code>{"args": ["-y", "@modelcontextprotocol/server-github"]}</code></li>
                    <li>Filesystem: <code>{"args": ["-y", "@modelcontextprotocol/server-filesystem", "D:/allowed/path"]}</code></li>
                </ul>
            `
        },
        'http-sse': {
            name: 'HTTP/SSE',
            config: {
                name: "My HTTP MCP",
                description: "Description of your HTTP/SSE MCP service",
                url: "http://localhost:3000/sse",
                out_port: 17003,
                is_enabled: true,
                type: "sse",
                headers: {},
                host: "127.0.0.1"
            },
            help: `
                <h4>HTTP/SSE Configuration</h4>
                <pre>{
    "name": "My HTTP MCP",
    "description": "Description of your HTTP/SSE MCP service",
    "url": "http://localhost:3000/sse",
    "out_port": 17003,
    "is_enabled": true,
    "type": "sse",
    "headers": {},
    "host": "127.0.0.1"
}</pre>
                <p><strong>Required fields:</strong></p>
                <ul>
                    <li><strong>out_port:</strong> Unique port number (17001-17999 recommended)</li>
                    <li><strong>url:</strong> Full URL to the MCP service endpoint</li>
                    <li><strong>type:</strong> Service type: "sse" or "streamableHttp"</li>
                </ul>
                <p><strong>Optional fields:</strong></p>
                <ul>
                    <li><strong>name:</strong> Display name</li>
                    <li><strong>description:</strong> Service description</li>
                    <li><strong>is_enabled:</strong> Auto-start (default: true)</li>
                    <li><strong>headers:</strong> HTTP headers (e.g., {"Authorization": "Bearer xxx"})</li>
                    <li><strong>host:</strong> Bind address (default: "127.0.0.1")</li>
                </ul>
                <p><strong>Service Types:</strong></p>
                <ul>
                    <li><strong>sse:</strong> Server-Sent Events (recommended for most cases)</li>
                    <li><strong>streamableHttp:</strong> Streaming HTTP</li>
                </ul>
            `
        }
    };

    // 简单的全局变量
    let originalContent = '';
    let currentContent = '';
    {% if edit_type == 'service' %}
    const serviceName = '{{ service_name }}';
    const editType = 'service';
    {% elif edit_type == 'add_service' %}
    const editType = 'add_service';
    {% else %}
    const editType = 'config';
    {% endif %}

    // Apply template
    function applyTemplate() {
        const select = document.getElementById('template-select');
        const templateKey = select.value;

        if (!templateKey || !templates[templateKey]) {
            return;
        }

        const template = templates[templateKey];
        const editor = document.getElementById('json-editor');

        // Apply template config to editor
        editor.value = JSON.stringify(template.config, null, 2);
        currentContent = editor.value;

        // Update help content
        updateHelpContent(template.help);

        // Validate JSON
        validateJSON();
    }

    // Update help content
    function updateHelpContent(helpHTML) {
        const helpContent = document.getElementById('help-content');
        if (helpContent) {
            helpContent.innerHTML = helpHTML;
        }
    }

    // 获取当前编辑器内容
    function getCurrentContent() {
        const editor = document.getElementById('json-editor');
        return editor ? editor.value : currentContent;
    }

    // 验证 JSON 格式
    function validateJSON() {
        const statusElement = document.getElementById('json-status');
        const errorElement = document.getElementById('error-message');
        const currentContent = getCurrentContent();

        try {
            if (currentContent.trim() === '') {
                statusElement.textContent = 'Empty';
                statusElement.className = 'mcp-edit-json-status mcp-edit-status-invalid';
                errorElement.style.display = 'none';
                return false;
            }

            const parsed = JSON.parse(currentContent);

            // 检查必需字段
            {% if edit_type == 'service' %}
            if (!parsed.out_port) {
                throw new Error('Missing required field: out_port');
            }
            {% endif %}

            statusElement.textContent = 'Valid JSON';
            statusElement.className = 'mcp-edit-json-status mcp-edit-status-valid';
            errorElement.style.display = 'none';
            return true;
        } catch (error) {
            statusElement.textContent = 'Invalid JSON';
            statusElement.className = 'mcp-edit-json-status mcp-edit-status-invalid';
            errorElement.textContent = 'JSON Syntax Error: ' + error.message;
            errorElement.style.display = 'block';
            return false;
        }
    }

    // 格式化 JSON
    function formatJSON() {
        try {
            const currentContent = getCurrentContent();
            if (currentContent.trim() === '') {
                alert('No content to format');
                return;
            }

            const parsed = JSON.parse(currentContent);
            const formatted = JSON.stringify(parsed, null, 2);
            const editor = document.getElementById('json-editor');
            editor.value = formatted;
            validateJSON();
        } catch (error) {
            alert('Cannot format invalid JSON: ' + error.message);
        }
    }

    // 重置到原始内容
    function resetToOriginal() {
        if (confirm('Are you sure you want to reset to the original configuration? All changes will be lost.')) {
            const editor = document.getElementById('json-editor');
            editor.value = originalContent;
            validateJSON();

            // Reset template selector
            {% if edit_type == 'add_service' %}
            const templateSelect = document.getElementById('template-select');
            if (templateSelect) {
                templateSelect.value = "";
                updateHelpContent(document.getElementById('help-default').outerHTML);
            }
            {% endif %}
        }
    }

    // 删除
    async function deleteService() {
        let r = confirm('Are you sure to DELETE this MCP service?')
        if (r) {
            url = `/api/services/${encodeURIComponent(serviceName)}/delete`;

            response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/plain',
                },
            });
        }
    }

    // 保存配置
    async function saveConfiguration() {
        if (!validateJSON()) {
            alert('Please fix JSON syntax errors before saving.');
            return;
        }

        try {
            const currentContent = getCurrentContent();
            let response, url;

            {% if edit_type == 'service' %}
            url = `/api/services/${encodeURIComponent(serviceName)}/save`;
            {% elif edit_type == 'add_service' %}
            url = '/api/config/add-service';
            {% else %}
            url = '/api/config/save';
            {% endif %}

            response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/plain',
                },
                body: currentContent
            });

            const result = await response.json();

            if (result.success) {
                alert('{% if edit_type == "service" %}Service configuration saved successfully!{% elif edit_type == "add_service" %}New service added successfully!{% else %}Configuration saved successfully!{% endif %}');
                originalContent = currentContent;

                // 通知父页面刷新
                if (window.parent) {
                    const messageType = {% if edit_type == 'service' %}'MCP_SERVICE_SAVED'{% elif edit_type == 'add_service' %}'MCP_CONFIG_SAVED'{% else %}'MCP_CONFIG_SAVED'{% endif %};
                    const messageData = {
                        type: messageType
                    };

                    {% if edit_type == 'service' %}
                    messageData.serviceName = serviceName;
                    {% endif %}

                    window.parent.postMessage(messageData, '*');
                }
            } else {
                alert('Failed to save {% if edit_type == "service" %}service{% elif edit_type == "add_service" %}new service{% else %}configuration{% endif %}: ' + result.error);
            }
        } catch (error) {
            alert('Error saving {% if edit_type == "service" %}service{% elif edit_type == "add_service" %}new service{% else %}configuration{% endif %}: ' + error.message);
        }
    }

    // 关闭编辑器
    function closeEditor() {
        const currentContent = getCurrentContent();
        if (currentContent !== originalContent) {
            if (confirm('You have unsaved changes. Are you sure you want to close?')) {
                // 通知父页面关闭模态框
                if (window.parent) {
                    window.parent.postMessage({
                        type: 'MCP_CLOSE_MODAL'
                    }, '*');
                }
            }
        } else {
            // 通知父页面关闭模态框
            if (window.parent) {
                window.parent.postMessage({
                    type: 'MCP_CLOSE_MODAL'
                }, '*');
            }
        }
    }

    // 初始化
    document.addEventListener('DOMContentLoaded', function() {
        const editor = document.getElementById('json-editor');
        if (editor) {
            originalContent = editor.value;
            currentContent = originalContent;

            // 监听内容变化
            editor.addEventListener('input', function() {
                currentContent = this.value;
                validateJSON();
            });

            // 初始验证
            validateJSON();
        }

        console.log('MCP Edit page initialized - Type:', editType, {% if edit_type == 'service' %}'Service:', serviceName{% endif %});
    });

    // 键盘快捷键
    document.addEventListener('keydown', function(e) {
        // Ctrl+S 保存
        if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            saveConfiguration();
        }
        // Ctrl+F 格式化
        if (e.ctrlKey && e.key === 'f') {
            e.preventDefault();
            formatJSON();
        }
        // Escape 关闭
        if (e.key === 'Escape') {
            closeEditor();
        }
    });
</script>
</body>
</html>