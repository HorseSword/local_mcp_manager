<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    <title>Local MCP Manager</title>
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
</head>
<body>

    <div class="container">
        <h1>Local MCP Manager</h1>
        <div class="header">
            <button class="btn btn-primary" onclick="startAllServices()">Batch Start</button>
            <button class="btn btn-danger" onclick="stopAllServices()">Batch Stop</button>
            <button class="btn btn-secondary" onclick="refreshServices()">Refresh</button>
            <button class="btn btn-secondary" onclick="addMCP()">Add MCP</button>
            <button class="btn btn-secondary" onclick="editConfig()">Edit Config File</button>
            <button class="btn btn-danger" onclick="reboot()">Reboot</button>
        </div>
        <div id="message" class="message"></div>
        
        <table id="servicesTable">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>In Type</th>
                    <th>Out Type</th>
                    <th>Out Port</th>
                    <th>Batch Start Enabled</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="servicesBody">
                <!-- 服务数据将通过 JavaScript 填充 -->
            </tbody>
        </table>
    
    </div>
    <center id="tail" style="padding-top: 2em;">
        Manage and test all your MCP services. Open Source at <a href="https://github.com/HorseSword/local_mcp_manager" target="_blank" rel="noopener">https://github.com/HorseSword/local_mcp_manager</a>
    </center>
    
    <!-- 模态框结构 (默认隐藏) -->
    <div id="myModal" class="modal-overlay">
        <!-- 关闭按钮 - 移到模态框外部 -->
        <span class="close-btn">&times;</span>

        <div class="modal-content">
            <!-- 这里是动态加载内容的容器 -->
            <div id="modal-body-wrapper" style="height: 100%; overflow: hidden;">
                <p>正在加载数据...</p>
            </div>
        </div>
    </div>

    <script>
        let refreshInterval;

        // 获取 DOM 元素
        const modal = document.getElementById("myModal");
        const contentWrapper = document.getElementById("modal-body-wrapper");
        const closeBtn = document.querySelector(".close-btn");

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            refreshServices();
            startAutoRefresh();
            listMcpTools();
        });
        
        // 显示消息
        function showMessage(text, type = 'success') {
            const messageEl = document.getElementById('message');
            messageEl.style.transition = 'opacity 100ms ease';
            messageEl.textContent = text;
            messageEl.className = `message ${type}`;
            messageEl.style.display = 'block';
            // messageEl.style.top = '-100px';
            messageEl.style.opacity = '0';
            
            setTimeout(() => {
                // messageEl.style.top = '100px';
                messageEl.style.opacity = '1';
            }, 0);

            setTimeout(() => {
                // messageEl.style.top = '-100px';
                messageEl.style.opacity = '0';
            }, 3000);

            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 3200);
        }
        
        // 设置加载状态
        function setLoading(loading) {
            const container = document.querySelector('.container');
            if (loading) {
                container.classList.add('loading');
            } else {
                container.classList.remove('loading');
            }
        }
        
        // 获取服务列表
        async function refreshServices() {
            try {
                const response = await fetch('/api/services');
                const data = await response.json();
                
                if (data.success) {
                    updateServicesTable(data.services);
                } else {
                    showMessage('Loading server list failed', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }
        
        // 更新服务表格
        function updateServicesTable(services) {
            const tbody = document.getElementById('servicesBody');
            tbody.innerHTML = '';
            
            services.forEach(service => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <span class="${service.mcp_status=='ON' ? 'srv-running' : 'srv-stopped'}" 
                            ${service.mcp_status=='ON' ? `onclick="infoService('${service.name}')"`:""}>
                            ${service.name}
                        </span>
                    </td>
                    <td>${service.in_type}</td>
                    <td>${service.out_type}</td>
                    <td>${service.port}</td>
                    <td>
                        <span class="${service.is_enabled ? 'status-yes' : 'status-no'}" 
                              style="cursor: pointer;" 
                              onclick="toggleEnabled('${service.name}')"
                              title="Click to switch status.">
                            ${service.is_enabled ? 'Yes' : 'No'}
                        </span>
                    </td>
                    <td>
                        <span class="${service.mcp_status=='ON' ? 'status-yes' : 'status-no'}">
                            <!-- ${service.is_alive ? 'Yes' : 'No'} -->
                            ${service.mcp_status}
                        </span>
                    </td>
                    <td class="actions">
                        <button class="btn ${service.is_alive ? 'btn-disabled':'btn-primary' } btn-sm" 
                                ${service.is_alive? "":`onclick="startService('${service.name}')"`}
                                ${service.is_alive ? 'disabled' : ''}>
                            Start
                        </button>
                        <button class="btn ${service.is_alive? 'btn-danger':'btn-disabled'} btn-sm" 
                                ${service.is_alive? `onclick="stopService('${service.name}')"`:""}
                                ${!service.is_alive ? 'disabled' : ''}>
                            Stop
                        </button>
                        <button class="btn ${service.is_alive? 'btn-secondary':'btn-disabled'} btn-sm" 
                                ${service.is_alive? `onclick="infoService('${service.name}')"`:""}>
                            Info
                        </button>
                        <button class="btn btn-secondary btn-sm .edit-btn" 
                                onclick="editService('${service.name}')">
                            Edit
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Reboot
        async function reboot() {
            setLoading(true);
            try {
                const response = await fetch('/api/services/reboot', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    showMessage(data.message);
                    await refreshServices();
                } else {
                    showMessage('Reboot finished.', 'error');
                }
            } catch (error) {
                showMessage('Reboot Error: ' + error.message, 'error');
            } finally {
                setLoading(false);
            }
        }
        /**
        /* 批量启动服务
        **/
        async function startAllServices() {
            setLoading(true);
            try {
                const response = await fetch('/api/services/start-all', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    showMessage(data.message);
                    await refreshServices();
                } else {
                    showMessage('Batch start failed', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            } finally {
                setLoading(false);
            }
        }
        
        // 批量停止服务
        async function stopAllServices() {
            setLoading(true);
            try {
                const response = await fetch('/api/services/stop-all', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    showMessage(data.message);
                    await refreshServices();
                } else {
                    showMessage('Batch stop failed.', 'error');
                }
            } catch (error) {
                showMessage('Network Error: ' + error.message, 'error');
            } finally {
                setLoading(false);
            }
        }
        
        // 启动单个服务
        async function startService(serviceName) {
            try {
                const response = await fetch(`/api/services/${encodeURIComponent(serviceName)}/start`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    showMessage(data.message);
                    await refreshServices();
                } else {
                    showMessage(data.message, 'error');
                }
            } catch (error) {
                showMessage('Network Error: ' + error.message, 'error');
            }
        }
        
        // 停止单个服务
        async function stopService(serviceName) {
            try {
                const response = await fetch(`/api/services/${encodeURIComponent(serviceName)}/stop`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    showMessage(data.message);
                    await refreshServices();
                } else {
                    showMessage(data.message, 'error');
                }
            } catch (error) {
                showMessage('Network Error: ' + error.message, 'error');
            }
        }

        // 列出MCP工具列表，并同步触发MCP工具执行
        async function listMcpTools(){
            try {
                const response = await fetch(`/api/all`);
                if (!response.ok) {
                   throw new Error(`HTTP error! status: ${response.status}`);
                }    
                const result = await response.text(); // 获取响应体为字符串
                return result;
            } 
            catch (error) {
                console.error('请求失败:', error);
                throw error; // 可根据需要选择 re-throw 或返回默认值
            }
        }

        // 查看MCP服务
        async function infoService(serviceName) {
            console.log('Opening info service for:', serviceName);

            // 显示模态框
            showModal();

            // 创建iframe
            const iframe = document.createElement('iframe');
            const infoUrl = `/api/services/${encodeURIComponent(serviceName)}/info`;
            console.log('Loading iframe URL:', infoUrl);

            iframe.src = infoUrl;
            iframe.name = 'iframeWindow';
            // 设置内容框高度，不是遮罩层高度
            const modalContent = document.querySelector('.modal-content');
            modalContent.style.height = '80vh';
            modalContent.style.maxHeight = '80vh';

            iframe.style.width = '100%';
            iframe.style.height = '100%'; // 'calc(80vh - 120px)'; // 减去头部、按钮和边距
            iframe.style.border = 'none';
            iframe.style.borderRadius = '6px';
            iframe.style.background = 'white';
            iframe.style.boxSizing = 'border-box';
            iframe.style.display = 'block';
            iframe.style.overflow = 'hidden';

            // 清空内容容器并添加iframe
            contentWrapper.innerHTML = '';
            contentWrapper.appendChild(iframe);

            // 监听iframe消息（复用现有的消息处理器）
            if (!window.mcpMessageHandler) {
                window.mcpMessageHandler = function(event) {
                    console.log('Received message from iframe:', event.data);
                    if (event.data && event.data.type) {
                        switch (event.data.type) {
                            case 'MCP_SERVICE_SAVED':
                                console.log('Service saved:', event.data.serviceName);
                                refreshServices();
                                break;
                            case 'MCP_CLOSE_MODAL':
                                console.log('Closing modal from iframe');
                                closeModal();
                                break;
                        }
                    }
                };
                window.addEventListener('message', window.mcpMessageHandler);
            }

            // 监听iframe加载事件
            iframe.onload = function() {
                console.log('iframe loaded for service info:', serviceName);
            };

            iframe.onerror = function() {
                console.error('Failed to load iframe for service info:', serviceName);
                showMessage('Failed to load service info', 'error');
                closeModal();
            };

            // 设置超时检查
            setTimeout(() => {
                try {
                    if (iframe.contentWindow && iframe.contentWindow.location.href === 'about:blank') {
                        console.error('iframe failed to load');
                        showMessage('Failed to load service info', 'error');
                        closeModal();
                    }
                } catch (e) {
                    console.log('iframe access error (normal for cross-origin):', e.message);
                }
            }, 10000);
        }
        
        // 编辑MCP服务
        async function editService(serviceName) {
            try {
                console.log('Opening edit service for:', serviceName);
                showModal();

                // 创建iframe
                const iframe = document.createElement('iframe');
                const editUrl = `/api/services/${encodeURIComponent(serviceName)}/edit`;
                console.log('Loading iframe URL:', editUrl);

                iframe.src = editUrl;
                // 设置内容框高度，不是遮罩层高度
                const modalContent = document.querySelector('.modal-content');
                modalContent.style.height = '80vh';
                modalContent.style.maxHeight = '80vh';

                iframe.style.width = '100%';
                iframe.style.height = '100%'; // 'calc(80vh - 120px)'; // 减去头部、按钮和边距
                iframe.style.border = 'none';
                iframe.style.borderRadius = '6px';
                iframe.style.background = 'white';
                iframe.style.boxSizing = 'border-box';
                iframe.style.display = 'block';

                // 清空内容容器并添加iframe
                contentWrapper.innerHTML = '';
                contentWrapper.appendChild(iframe);

                // 监听iframe消息（只添加一次）
                if (!window.mcpMessageHandler) {
                    window.mcpMessageHandler = function(event) {
                        console.log('Received message from iframe:', event.data);
                        if (event.data && event.data.type) {
                            switch (event.data.type) {
                                case 'MCP_SERVICE_SAVED':
                                    console.log('Service saved:', event.data.serviceName);
                                    refreshServices();
                                    break;
                                case 'MCP_CLOSE_MODAL':
                                    console.log('Closing modal from iframe');
                                    closeModal();
                                    break;
                            }
                        }
                    };
                    window.addEventListener('message', window.mcpMessageHandler);
                }

                // 监听iframe加载事件
                iframe.onload = function() {
                    console.log('iframe loaded for service:', serviceName);
                };

                iframe.onerror = function() {
                    console.error('Failed to load iframe for service:', serviceName);
                    showMessage('Failed to load edit service iframe', 'error');
                };

                // 设置超时检查
                setTimeout(() => {
                    try {
                        if (iframe.contentWindow && iframe.contentWindow.location.href === 'about:blank') {
                            console.error('iframe failed to load');
                            showMessage('Failed to load edit service page', 'error');
                        }
                    } catch (e) {
                        console.log('iframe access error (normal for cross-origin):', e.message);
                    }
                }, 2000);

            } catch (error) {
                console.error('Error loading edit service form:', error);
                showMessage('Failed to load edit service form: ' + error.message, 'error');
                closeModal();
            }
        }

        // 添加MCP服务
        async function addMCP() {
            try {
                console.log('Opening add MCP form');
                showModal();

                // 创建iframe
                const iframe = document.createElement('iframe');
                const addUrl = '/api/config/add';
                console.log('Loading iframe URL:', addUrl);

                iframe.src = addUrl;
                // 设置内容框高度，不是遮罩层高度
                const modalContent = document.querySelector('.modal-content');
                modalContent.style.height = '80vh';
                modalContent.style.maxHeight = '80vh';

                iframe.style.width = '100%';
                iframe.style.height = '100%'; // 'calc(80vh - 120px)'; // 减去头部、按钮和边距
                iframe.style.border = 'none';
                iframe.style.borderRadius = '6px';
                iframe.style.background = 'white';
                iframe.style.boxSizing = 'border-box';
                iframe.style.display = 'block';

                // 清空内容容器并添加iframe
                contentWrapper.innerHTML = '';
                contentWrapper.appendChild(iframe);

                // 监听iframe消息（复用现有的消息处理器）
                if (!window.mcpMessageHandler) {
                    window.mcpMessageHandler = function(event) {
                        console.log('Received message from iframe:', event.data);
                        if (event.data && event.data.type) {
                            switch (event.data.type) {
                                case 'MCP_CONFIG_SAVED':
                                    console.log('Configuration saved');
                                    refreshServices();
                                    break;
                                case 'MCP_CLOSE_MODAL':
                                    console.log('Closing modal from iframe');
                                    closeModal();
                                    break;
                            }
                        }
                    };
                    window.addEventListener('message', window.mcpMessageHandler);
                }

                // 监听iframe加载事件
                iframe.onload = function() {
                    console.log('iframe loaded for add MCP form');
                };

                iframe.onerror = function() {
                    console.error('Failed to load iframe for add MCP form');
                    showMessage('Failed to load add MCP form', 'error');
                };

                // 设置超时检查
                setTimeout(() => {
                    try {
                        if (iframe.contentWindow && iframe.contentWindow.location.href === 'about:blank') {
                            console.error('iframe failed to load');
                            showMessage('Failed to load add MCP form', 'error');
                        }
                    } catch (e) {
                        console.log('iframe access error (normal for cross-origin):', e.message);
                    }
                }, 2000);

            } catch (error) {
                console.error('Error loading add MCP form:', error);
                showMessage('Failed to load add MCP form: ' + error.message, 'error');
                closeModal();
            }
        }

        // 编辑配置
        async function editConfig() {
            try {
                console.log('Opening edit config form');
                showModal();

                // 创建iframe
                const iframe = document.createElement('iframe');
                const editUrl = '/api/config/edit';
                console.log('Loading iframe URL:', editUrl);

                iframe.src = editUrl;
                // 设置内容框高度，不是遮罩层高度
                const modalContent = document.querySelector('.modal-content');
                modalContent.style.height = '80vh';
                modalContent.style.maxHeight = '80vh';

                iframe.style.width = '100%';
                iframe.style.height = '100%'; // 'calc(80vh - 120px)'; // 减去头部、按钮和边距
                iframe.style.border = 'none';
                iframe.style.borderRadius = '6px';
                iframe.style.background = 'white';
                iframe.style.boxSizing = 'border-box';
                iframe.style.display = 'block';
                iframe.style.overflowY = 'hidden';

                // 清空内容容器并添加iframe
                contentWrapper.innerHTML = '';
                contentWrapper.appendChild(iframe);

                // 监听iframe消息（复用现有的消息处理器）
                if (!window.mcpMessageHandler) {
                    window.mcpMessageHandler = function(event) {
                        console.log('Received message from iframe:', event.data);
                        if (event.data && event.data.type) {
                            switch (event.data.type) {
                                case 'MCP_CONFIG_SAVED':
                                    console.log('Configuration saved');
                                    refreshServices();
                                    break;
                                case 'MCP_CLOSE_MODAL':
                                    console.log('Closing modal from iframe');
                                    closeModal();
                                    break;
                            }
                        }
                    };
                    window.addEventListener('message', window.mcpMessageHandler);
                }

                // 监听iframe加载事件
                iframe.onload = function() {
                    console.log('iframe loaded for edit config form');
                };

                iframe.onerror = function() {
                    console.error('Failed to load iframe for edit config form');
                    showMessage('Failed to load edit config form', 'error');
                };

                // 设置超时检查
                setTimeout(() => {
                    try {
                        if (iframe.contentWindow && iframe.contentWindow.location.href === 'about:blank') {
                            console.error('iframe failed to load');
                            showMessage('Failed to load edit config form', 'error');
                        }
                    } catch (e) {
                        console.log('iframe access error (normal for cross-origin):', e.message);
                    }
                }, 2000);

            } catch (error) {
                console.error('Error loading edit config form:', error);
                showMessage('Failed to load edit config form: ' + error.message, 'error');
                closeModal();
            }
        }
        
        // 切换服务启用状态
        async function toggleEnabled(serviceName) {
            try {
                const response = await fetch(`/api/services/${encodeURIComponent(serviceName)}/toggle`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    showMessage(data.message);
                    await refreshServices();
                } else {
                    showMessage(data.message, 'error');
                }
            } catch (error) {
                showMessage('Network Error: ' + error.message, 'error');
            }
        }
        
        // 自动刷新
        function startAutoRefresh() {
            refreshInterval = setInterval(refreshServices, 2000); // 每2秒刷新一次
        }
        
        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        }
        
        // 页面关闭时停止自动刷新
        window.addEventListener('beforeunload', function() {
            stopAutoRefresh();
        });
        
        // 页面获得焦点时重新开始自动刷新
        window.addEventListener('focus', function() {
            if (!refreshInterval) {
                startAutoRefresh();
            }
        });
        
        // 页面失去焦点时停止自动刷新（节省资源）
        window.addEventListener('blur', stopAutoRefresh);

        //
        function showModal() {
            modal.style.display = "block";
        }
        
        // 关闭模态框并中止请求的通用函数
        function closeModal() {
            modal.style.display = "none";
        }

        // 2. 关闭模态框逻辑 (点击 X)
        closeBtn.onclick = function() {
            closeModal();
        }

        // 3. 关闭模态框逻辑 (点击遮罩层背景)
        window.onclick = function(event) {
            if (event.target == modal) {
                closeModal();
            }
        }

    </script>
    
</body>
</html>